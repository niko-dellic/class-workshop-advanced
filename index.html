<html>
  <head>
    <!-- deck.gl standalone bundle -->
    <script src="https://unpkg.com/deck.gl@^8.8.0/dist.min.js"></script>

    <!-- Mapbox dependencies -->
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.13.0/mapbox-gl.js"></script>
    <link
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.13.0/mapbox-gl.css"
      rel="stylesheet"
    />

    <style type="text/css">
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        width: 100vw;
        height: 100vh;
      }
      #panel {
        position: absolute;
        top: 1rem;
        left: 1rem;
        padding: 10px;
        background: black;
        color: white;
        z-index: 1;
        font-family: Helvetica, sans-serif;
        transition: 0.5s ease-in-out;
        opacity: 0;
      }

      .exit {
        cursor: pointer;
        margin-bottom: 1rem;
        padding: 0.35rem;
        float: right;
      }
    </style>
  </head>

  <body>
    <script>
      function hidePanel() {
        document.getElementById("panel").style.opacity = 0;
      }
    </script>
    <div id="map"></div>
    <tooltip id="panel"
      ><div class="exit" onclick="hidePanel()">X</div>
      <div></div>
    </tooltip>
  </body>

  <script type="text/javascript">
    // source: Natural Earth http://www.naturalearthdata.com/ via geojson.xyz

    const heat = "./heatVulnerability.geojson";

    function map_range(value, low1, high1, low2, high2) {
      return low2 + ((high2 - low2) * (value - low1)) / (high1 - low1);
    }

    function flyToClick(coords) {
      deckgl.setProps({
        initialViewState: {
          longitude: coords[0],
          latitude: coords[1],
          zoom: 15,
          transitionDuration: 500,
          transitionInterpolator: new deck.FlyToInterpolator(),
        },
      });
    }

    const panel = document.getElementById("panel");
    const panelChild = document.querySelector("#panel :nth-child(2)");

    const deckgl = new deck.DeckGL({
      container: "map",
      // Set your Mapbox access token here
      mapboxApiAccessToken:
        "pk.eyJ1Ijoibmlrby1kZWxsaWMiLCJhIjoiY2w5c3p5bGx1MDh2eTNvcnVhdG0wYWxkMCJ9.4uQZqVYvQ51iZ64yG8oong",
      mapStyle: "mapbox://styles/niko-dellic/cl9t226as000x14pr1hgle9az",
      initialViewState: {
        latitude: 39.9526,
        longitude: -75.1652,
        zoom: 12,
        bearing: 0,
        pitch: 0,
      },
      controller: true,

      layers: [
        new deck.GeoJsonLayer({
          id: "heat",
          data: heat,
          // Styles
          filled: true,
          stroke: false,
          getFillColor: (d) => {
            const abs = Math.abs(d.properties.HSI_SCORE);
            const color = map_range(abs, 0, 3.5, 0, 255);

            return d.properties.HSI_SCORE
              ? d.properties.HSI_SCORE < 0
                ? [60, 60, color, 0]
                : [color, 60, 72, color + 66]
              : [0, 0, 0, 0];
          },
          getStrokeColor: [0, 0, 0, 255],
          LineWidthUnits: "meters",
          getLineWidth: 35,
          // Interactive props
          pickable: true,
          autoHighlight: true,
          highlightColor: [255, 255, 255, 200],
          onClick: (info) => {
            flyToClick(info.coordinate);

            panelChild.innerHTML = `<strong>Census Tract #${
              info.object.properties.NAME10
            }</strong>
          <br></br>
          HSI SCORE: ${info.object.properties.HSI_SCORE.toFixed(
            2 || "N/A"
          )} <br></br>
          HEI SCORE: ${info.object.properties.HEI_SCORE.toFixed(2 || "N/A")}
          <br></br>
          HVI SCORE: ${info.object.properties.HVI_SCORE.toFixed(2 || "N/A")}
          <br></br>
          Coordinates:
          ${info.coordinate[0].toFixed(3)},
          ${info.coordinate[1].toFixed(3)}`;
            panel.style.opacity = 1;
          },
        }),
      ],
    });
  </script>
</html>
